<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Settings - GoStudy!</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons+Round"
      rel="stylesheet"
    />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#007AFF",
              secondary: "#F5F5F7",
              dark: "#1D1D1F",
              danger: "#FF3B30",
              success: "#34C759",
            },
            fontFamily: {
              sans: ["Inter", "-apple-system", "sans-serif"],
              mono: ["JetBrains Mono", "monospace"],
            },
            boxShadow: {
              subtle: "0 1px 2px rgba(0,0,0,0.05)",
              premium: "0 20px 40px -10px rgba(0,0,0,0.05)",
            },
          },
        },
      };
    </script>
    <link rel="icon" href="/assets/go-logo.png?v=2" type="image/png" />
    <script type="module" src="/backend/js/auth.js"></script>

    <style>
      /* Hide scrollbar while keeping scroll functionality */
      html {
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE/Edge */
      }
      html::-webkit-scrollbar {
        display: none; /* Chrome, Safari, Opera */
      }

      /* Navbar Dropdowns */
      .nav-item:hover .dropdown-menu {
        opacity: 1;
        visibility: visible;
        transform: translateY(0) translateX(-50%);
        pointer-events: auto;
      }
      .dropdown-menu {
        opacity: 0;
        visibility: hidden;
        transform: translateY(10px) translateX(-50%);
        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        pointer-events: none;
      }

      /* Mobile Menu */
      .mobile-menu-overlay {
        background: rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(4px);
      }

      .pfp-option {
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        border: 3px solid transparent;
      }
      .pfp-option:hover {
        transform: scale(1.05);
        border-color: rgba(0, 122, 255, 0.2);
      }
      .pfp-option.selected {
        border-color: #007AFF;
        box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        transform: scale(1.08);
      }
    </style>
  </head>
  <body class="bg-[#F5F5F7] text-dark font-sans antialiased min-h-screen">
      <!-- navbar -->
  <header id="main-header" class="fixed top-0 left-0 right-0 z-50 bg-white/80 backdrop-blur-xl border-b border-white/20 transition-all duration-300">
    <div class="max-w-7xl mx-auto px-6 h-20 flex items-center justify-between">
      
      <!-- Logo -->
      <a class="flex items-center gap-2 group" href="/index.html">
        <div class="relative w-10 h-10 overflow-hidden">
            <img src="/assets/go-logo.png?v=2" class="w-25 h-25" alt="Logo">
        </div>
        <span class="font-bold text-xl tracking-tight text-dark">GoStudy!</span>
      </a>

      <!-- Desktop Navigation -->
      <nav class="hidden md:flex items-center gap-2">
        
        <!-- Products Dropdown -->
        <div class="nav-item relative group px-4 py-3">
          <button class="flex items-center gap-1 text-sm font-semibold text-gray-600 group-hover:text-primary transition-colors">
            Products
            <span class="material-icons-round text-lg opacity-50 group-hover:rotate-180 transition-transform">expand_more</span>
          </button>
          
          <div class="dropdown-menu absolute top-full left-1/2 -translate-x-1/2 w-[700px] pt-4">
            <div class="bg-white rounded-3xl p-6 shadow-premium border border-gray-100 grid grid-cols-2 gap-6 relative overflow-hidden">
               
               <div class="absolute top-0 right-0 w-64 h-64 bg-blue-50/50 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>

               <!-- Left Col -->
               <div class="space-y-2">
                  <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">Core Platform</h4>
                  
                  <a href="/ai-chat/" class="flex items-start gap-4 p-3 rounded-2xl hover:bg-gray-100 transition-colors group/item">
                    <div class="w-10 h-10 rounded-full bg-red-50 text-red-600 flex items-center justify-center group-hover/item:scale-110 transition-transform">
                        <span class="material-icons-round text-xl">chat</span>
                    </div>
                    <div>
                        <p class="font-bold text-dark text-sm">AI Chat</p>
                        <p class="text-xs text-gray-500 mt-1">Chat with our AI assistant Nova.</p>
                    </div>
                  </a>

                  <a href="/methodology/" class="flex items-start gap-4 p-3 rounded-2xl hover:bg-gray-100 transition-colors group/item">
                    <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center group-hover/item:scale-110 transition-transform">
                        <span class="material-icons-round text-xl">psychology</span>
                    </div>
                    <div>
                        <p class="font-bold text-dark text-sm">Methodology</p>
                        <p class="text-xs text-gray-500 mt-1">Science-backed testing method.</p>
                    </div>
                  </a>

                  <a href="/pricing/" class="flex items-start gap-4 p-3 rounded-2xl hover:bg-gray-100 transition-colors group/item">
                    <div class="w-10 h-10 rounded-full bg-yellow-50 text-yellow-600 flex items-center justify-center group-hover/item:scale-110 transition-transform">
                        <span class="material-icons-round text-xl">monetization_on</span>
                    </div>
                    <div>
                        <p class="font-bold text-dark text-sm">Pricing</p>
                        <p class="text-xs text-gray-500 mt-1">Choose the plan that best fits your needs.</p>
                    </div>
                  </a>

                  <a href="/how-it-works/" class="flex items-start gap-4 p-3 rounded-2xl hover:bg-gray-100 transition-colors group/item">
                    <div class="w-10 h-10 rounded-full bg-purple-50 text-purple-600 flex items-center justify-center group-hover/item:scale-110 transition-transform">
                        <span class="material-icons-round text-xl text-purple-600">account_tree</span>
                    </div>
                    <div>
                        <p class="font-bold text-dark text-sm">Memory Palace</p>
                        <p class="text-xs text-gray-500 mt-1">AI-generated spatial maps.</p>
                    </div>
                  </a>
               </div>

               <!-- Right Col -->
               <div class="flex flex-col h-full">
                  <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">Plans</h4>
                  <a href="/pricing" class="block bg-dark rounded-2xl p-5 text-white flex-1 hover:shadow-lg transition-all group/card relative overflow-hidden">
                      <div class="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent opacity-0 group-hover/card:opacity-100 transition-opacity"></div>
                      <div class="relative z-10">
                          <div class="flex justify-between items-start mb-4">
                              <span class="bg-primary px-2 py-1 rounded text-[10px] font-bold">PRO</span>
                              <span class="material-icons-round">arrow_forward</span>
                          </div>
                          <p class="font-bold text-lg mb-1">Upgrade your <br>Study Game</p>
                          <p class="text-gray-400 text-xs">Unlock unlimited uploads and advanced spaced repetition.</p>
                      </div>
                  </a>
               </div>
            </div>
          </div>
        </div>

        <!-- Resources Dropdown -->
        <div class="nav-item relative group px-4 py-3">
          <button class="flex items-center gap-1 text-sm font-semibold text-gray-600 group-hover:text-primary transition-colors">
            Resources
            <span class="material-icons-round text-lg opacity-50 group-hover:rotate-180 transition-transform">expand_more</span>
          </button>
          
           <div class="dropdown-menu absolute top-full left-1/2 -translate-x-1/2 w-[400px] pt-4">
            <div class="bg-white rounded-3xl p-2 shadow-premium border border-gray-100">
               <a href="/articles/" class="flex items-center gap-4 p-3 rounded-2xl hover:bg-gray-100 transition-colors">
                   <div class="w-10 h-10 rounded-full bg-orange-50 text-orange-500 flex items-center justify-center">
                       <span class="material-icons-round">article</span>
                   </div>
                   <div class="flex-1">
                       <p class="font-bold text-dark text-sm">Articles & Guides</p>
                       <p class="text-xs text-gray-500">Study tips and neuroscience.</p>
                   </div>
               </a>
               <a href="/onboarding/" class="flex items-start gap-4 p-3 rounded-2xl hover:bg-gray-100 transition-colors group/item">
                    <div class="w-10 h-10 rounded-full bg-green-50 text-green-600 flex items-center justify-center group-hover/item:scale-110 transition-transform">
                        <span class="material-icons-round text-xl">person_add</span>
                    </div>
                    <div>
                        <p class="font-bold text-dark text-sm">Onboarding</p>
                        <p class="text-xs text-gray-500 mt-1">Start your journey with us.</p>
                    </div>
                  </a>
               <a href="/parents/" class="flex items-center gap-4 p-3 rounded-2xl hover:bg-gray-100 transition-colors">
                   <div class="w-10 h-10 rounded-full bg-pink-50 text-pink-500 flex items-center justify-center">
                       <span class="material-icons-round">family_restroom</span>
                   </div>
                   <div class="flex-1">
                       <p class="font-bold text-dark text-sm">For Parents</p>
                       <p class="text-xs text-gray-500">How to support your student.</p>
                   </div>
               </a>
               <a href="#faq" class="flex items-center gap-4 p-3 rounded-2xl hover:bg-gray-100 transition-colors">
                   <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center">
                       <span class="material-icons-round">help</span>
                   </div>
                   <div class="flex-1">
                       <p class="font-bold text-dark text-sm">Help Center</p>
                       <p class="text-xs text-gray-500">FAQs and Support.</p>
                   </div>
               </a>
            </div>
          </div>
        </div>

        <!-- Company Dropdown -->
        <div class="nav-item relative group px-4 py-3">
          <button class="flex items-center gap-1 text-sm font-semibold text-gray-600 group-hover:text-primary transition-colors">
            Company
            <span class="material-icons-round text-lg opacity-50 group-hover:rotate-180 transition-transform">expand_more</span>
          </button>
          
           <div class="dropdown-menu absolute top-full left-1/2 -translate-x-1/2 w-[300px] pt-4">
            <div class="bg-white rounded-3xl p-2 shadow-premium border border-gray-100">
               <a href="/about/" class="flex items-center gap-4 p-3 rounded-2xl hover:bg-gray-100 transition-colors">
                   <span class="font-bold text-dark text-sm ml-2">About Us</span>
               </a>
               <a href="/contact/" class="flex items-center gap-4 p-3 rounded-2xl hover:bg-gray-100 transition-colors">
                   <span class="font-bold text-dark text-sm ml-2">Contact</span>
               </a>
               <hr class="border-gray-100 my-1 mx-2">
               <a href="/privacy/" class="flex items-center gap-4 p-3 rounded-2xl hover:bg-gray-100 transition-colors">
                   <span class="text-gray-500 text-sm ml-2">Privacy Policy</span>
               </a>
               <a href="/terms/" class="flex items-center gap-4 p-3 rounded-2xl hover:bg-gray-100 transition-colors">
                   <span class="text-gray-500 text-sm ml-2">Terms of Service</span>
               </a>
            </div>
          </div>
        </div>

      </nav>

      <!-- CTA & Mobile Toggle -->
      <div class="flex items-center gap-4">
        <a href="/login/" class="hidden md:inline-flex bg-dark hover:bg-black text-white px-6 py-2.5 rounded-full text-sm font-bold transition-all shadow-lg shadow-black/5 hover:shadow-black/10 hover:-translate-y-0.5">
            Launch App
        </a>
        <button id="mobile-menu-btn" class="md:hidden p-2 text-dark">
            <span class="material-icons-round text-2xl">menu</span>
        </button>
      </div>

    </div>
  </header>

  <!-- mobile menu -->
  <div id="mobile-menu" class="fixed inset-0 z-[60] bg-white opacity-0 pointer-events-none transition-opacity duration-300 flex flex-col hidden">
      <div class="flex justify-between items-center p-6 border-b border-gray-100">
          <span class="font-bold text-xl text-dark">GoStudy!</span>
          <button id="mobile-menu-close" class="p-2 text-dark">
              <span class="material-icons-round text-2xl">close</span>
          </button>
      </div>
      <div class="p-6 flex-1 overflow-y-auto space-y-6">
          <!--mobile links -->
          <div class="space-y-4">
              <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Products</h4>
              <a href="/methodology/" class="block text-lg font-semibold text-dark">Active Recall</a>
              <a href="/how-it-works/" class="block text-lg font-semibold text-dark">Memory Palace</a>
              <a href="/pricing" class="block text-lg font-semibold text-dark">Pricing</a>
          </div>
          <div class="space-y-4">
              <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Resources</h4>
              <a href="/articles/" class="block text-lg font-semibold text-dark">Articles</a>
              <a href="/parents/" class="block text-lg font-semibold text-dark">For Parents</a>
              <a href="#faq" class="block text-lg font-semibold text-dark">Help Center</a>
          </div>
           <div class="space-y-4">
              <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Company</h4>
              <a href="/about/" class="block text-lg font-semibold text-dark">About</a>
              <a href="/contact/" class="block text-lg font-semibold text-dark">Contact</a>
          </div>
      </div>
      <div class="p-6 border-t border-gray-100">
          <a href="/login/" class="block w-full text-center bg-primary text-white py-4 rounded-xl font-bold text-lg">Launch App</a>
      </div>
  </div>

    <main class="max-w-3xl mx-auto px-6 py-32">
      <h1 class="text-3xl font-bold mb-8 text-dark">Settings</h1>

      <!-- Profile Section -->
      <div
        class="bg-white rounded-3xl p-8 shadow-sm border border-gray-200 mb-8"
      >
        <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
          <span class="material-icons-round text-gray-400">person</span>
          Profile
        </h2>

        <div class="flex flex-col md:flex-row items-center gap-6 mb-8">
          <div
            id="profile-pfp-container"
            class="w-24 h-24 rounded-full bg-gray-100 flex items-center justify-center text-3xl font-bold text-gray-400 border-4 border-white shadow-sm overflow-hidden"
          >
            <span id="profile-initials">JS</span>
            <img
              id="profile-img-display"
              src=""
              class="hidden w-full h-full object-cover"
              alt="Profile"
            />
          </div>
          <div class="flex-grow text-center md:text-left">
            <h3 id="profile-display-name-text" class="text-lg font-bold">
              John Student
            </h3>
            <p id="profile-email-text" class="text-gray-500">
              student@university.edu
            </p>
          </div>
          <button
            id="edit-profile-btn"
            class="px-5 py-2 border border-gray-200 rounded-full font-medium text-sm hover:bg-gray-50 transition-colors"
          >
            Update Profile
          </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div>
            <label
              class="block text-xs font-semibold text-gray-500 uppercase mb-2"
              >Display Name</label
            >
            <input
              type="text"
              id="profile-name"
              placeholder="Full Name"
              class="w-full rounded-xl border-gray-200 bg-gray-50 text-gray-700 focus:border-primary focus:ring-primary"
            />
          </div>
          <div>
            <label
              class="block text-xs font-semibold text-gray-500 uppercase mb-2"
              >Email</label
            >
            <input
              type="email"
              id="profile-email"
              placeholder="Email"
              class="w-full rounded-xl border-gray-200 bg-gray-50 text-gray-700 focus:border-primary focus:ring-primary"
            />
          </div>
        </div>
        <div>
          <label
            class="block text-xs font-semibold text-gray-500 uppercase mb-3"
            >Choose your Avatar</label
          >
          <input type="hidden" id="profile-pfp-url" />
          <div id="pfp-grid" class="grid grid-cols-4 md:grid-cols-7 gap-3 p-4 bg-gray-50 rounded-2xl max-h-60 overflow-y-auto scrollbar-hide">
            <!-- PFPs injected here -->
          </div>
        </div>
      </div>
      
      <!-- Study Preferences Section -->
      <div class="bg-white rounded-3xl p-8 shadow-sm border border-gray-200 mb-8">
        <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
            <span class="material-icons-round text-gray-400">tune</span>
            Study Preferences
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div>
                <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">Tone</label>
                <select id="pref-tone" class="w-full rounded-xl border-gray-200 bg-gray-50 text-gray-700 focus:border-primary focus:ring-primary p-3">
                    <option value="neutral">Neutral</option>
                    <option value="motivational">Motivational</option>
                    <option value="strict">Strict</option>
                    <option value="friendly">Friendly</option>
                    <option value="concise">Concise</option>
                </select>
                <p class="text-[10px] text-gray-400 mt-1">Defines the communication style.</p>
            </div>
            <div>
                <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">Pace</label>
                <select id="pref-pace" class="w-full rounded-xl border-gray-200 bg-gray-50 text-gray-700 focus:border-primary focus:ring-primary p-3">
                    <option value="relaxed">Relaxed</option>
                    <option value="balanced">Balanced</option>
                    <option value="intensive">Intensive</option>
                </select>
                <p class="text-[10px] text-gray-400 mt-1">Controls workload intensity.</p>
            </div>
            <div>
                <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">Reminder Frequency</label>
                <select id="pref-reminder" class="w-full rounded-xl border-gray-200 bg-gray-50 text-gray-700 focus:border-primary focus:ring-primary p-3">
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">Focus Preference</label>
                <select id="pref-focus" class="w-full rounded-xl border-gray-200 bg-gray-50 text-gray-700 focus:border-primary focus:ring-primary p-3">
                    <option value="theory">Theory</option>
                    <option value="practice">Practice</option>
                    <option value="mixed">Mixed</option>
                </select>
            </div>
        </div>
        <div class="flex items-center justify-between pt-4 border-t border-gray-100">
            <div class="flex items-center gap-3">
                 <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                    <input type="checkbox" name="toggle" id="pref-difficulty" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300 checked:right-0 right-6 checked:border-primary"/>
                    <label for="pref-difficulty" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer checked:bg-primary"></label>
                </div>
                <div class="flex flex-col">
                    <span class="text-sm font-bold text-gray-700">Adaptive Difficulty</span>
                    <span class="text-xs text-gray-400">Adjust plan based on performance</span>
                </div>
            </div>
            <button id="save-prefs-btn" class="bg-dark hover:bg-black text-white px-6 py-2 rounded-xl font-bold transition-all shadow-lg shadow-black/5 hover:shadow-black/10">
                Save Preferences
            </button>
        </div>
        <style>
            .toggle-checkbox:checked {
                right: 0;
                border-color: #007AFF;
            }
            .toggle-checkbox:checked + .toggle-label {
                background-color: #007AFF;
            }
            .toggle-checkbox {
                transition: all 0.3s;
            }
        </style>
      </div>

      <!-- Security Section -->
      <div
        class="bg-white rounded-3xl p-8 shadow-sm border border-gray-200 mb-8"
      >
        <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
          <span class="material-icons-round text-gray-400">security</span>
          Security
        </h2>
        <div class="space-y-4">
          <div>
            <label
              class="block text-xs font-semibold text-gray-500 uppercase mb-2"
              >New Password</label
            >
            <input
              type="password"
              id="profile-password"
              placeholder="••••••••"
              class="w-full rounded-xl border-gray-200 bg-gray-50 text-gray-700 focus:border-primary focus:ring-primary"
            />
          </div>
          <div class="flex justify-end">
            <button
              id="logout-btn"
              class="text-gray-500 text-sm font-medium hover:text-dark flex items-center gap-1"
            >
              <span class="material-icons-round text-sm">logout</span> Logout
            </button>
          </div>
        </div>
      </div>

      <!-- Subscription Section -->
      <div
        class="bg-white rounded-3xl p-8 shadow-sm border border-gray-200 mb-8"
      >
        <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
          <span class="material-icons-round text-gray-400">card_membership</span>
          Subscription
        </h2>
        <div id="subscription-container">
          <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
            <div class="flex items-center gap-4">
              <div id="plan-icon" class="w-14 h-14 rounded-2xl bg-blue-100 text-blue-600 flex items-center justify-center">
                <span class="material-icons-round text-2xl">person</span>
              </div>
              <div>
                <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Current Plan</p>
                <p id="plan-name" class="text-lg font-bold text-gray-900">Free Plan</p>
              </div>
            </div>
            <div id="plan-actions">
              <a href="/pricing/pro/" id="upgrade-btn" class="inline-flex items-center gap-2 bg-gradient-to-r from-amber-500 to-orange-500 text-white px-6 py-3 rounded-xl font-bold hover:shadow-lg transition-all">
                <span class="material-icons-round text-lg">star</span>
                Upgrade to Pro
              </a>
            </div>
          </div>
          
          <!-- Usage Stats -->
          <div class="mt-6 pt-6 border-t border-gray-100">
            <div class="flex items-center justify-between mb-3">
              <span class="text-sm font-medium text-gray-600">Monthly Uploads</span>
              <span id="usage-count" class="text-sm font-bold text-gray-900">0 / 3</span>
            </div>
            <div class="h-3 bg-gray-100 rounded-full overflow-hidden">
              <div id="usage-bar" class="h-full bg-gradient-to-r from-blue-500 to-indigo-500 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            <p id="usage-remaining" class="text-xs text-gray-400 mt-2">3 uploads remaining this month</p>
          </div>
        </div>
      </div>

      <!-- History Section -->
      <div
        class="bg-white rounded-3xl p-8 shadow-sm border border-gray-200 mb-8"
      >
        <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
          <span class="material-icons-round text-gray-400">history</span>
          Study History
        </h2>
        <div id="history-container" class="space-y-4">
          <p class="text-gray-400 text-sm text-center py-8">
            Loading history...
          </p>
        </div>
      </div>

      <!-- Danger Zone -->
      <div
        class="bg-red-50 rounded-3xl p-8 border border-red-100 opacity-80 hover:opacity-100 transition-opacity"
      >
        <h2 class="text-lg font-bold text-danger mb-4">Danger Zone</h2>
        <div
          class="flex flex-col md:flex-row justify-between items-center gap-4"
        >
          <p class="text-sm text-red-800">
            Once you delete your account, there is no going back. Please be
            certain.
          </p>
          <button
            id="delete-account-btn"
            class="text-red-600 border border-red-200 bg-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-red-50 hover:border-red-300 transition-all"
          >
            Delete Account
          </button>
        </div>
      </div>
    </main>

  <footer class="bg-white border-t border-gray-100 pt-24 pb-12">
    <div class="max-w-6xl mx-auto px-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-12 mb-20">
        <div class="col-span-1 md:col-span-2">
          <a class="font-bold text-2xl text-dark tracking-tight mb-6 block" href="/index.html">GoStudy!</a>
          <p class="text-gray-500 leading-relaxed max-w-sm mb-8">
            The intelligent study companion for high performers. We bridge the gap between information and mastery.
          </p>
        </div>
        
        <div>
          <h4 class="font-bold text-dark mb-8 uppercase text-xs tracking-widest">Product</h4>
          <ul class="space-y-4 text-sm text-gray-500 font-medium">
            <li><a href="/articles/" class="hover:text-primary transition-colors">Articles</a></li>
            <li><a href="/ai-chat/" class="hover:text-primary transition-colors">AI Chat</a></li>
            <li><a href="/pricing" class="hover:text-primary transition-colors">Pricing</a></li>
            <li><a href="/onboarding/" class="hover:text-primary transition-colors">Onboarding</a></li>
            <li><a href="/parents/" class="hover:text-primary transition-colors">Parents</a></li>
          </ul>
        </div>

        <div>
          <h4 class="font-bold text-dark mb-8 uppercase text-xs tracking-widest">Company</h4>
          <ul class="space-y-4 text-sm text-gray-500 font-medium">
            <li><a href="/about/" class="hover:text-primary transition-colors">About</a></li>
            <li><a href="/contact/" class="hover:text-primary transition-colors">Contact</a></li>
            <li><a href="/methodology/" class="hover:text-primary transition-colors">Methodology</a></li>
            <li><a href="/how-it-works/" class="hover:text-primary transition-colors">How It Works</a></li>
          </ul>
        </div>
      </div>

      <div class="border-t border-gray-100 pt-12 flex flex-col md:flex-row justify-between items-center gap-6 text-sm text-gray-400">
        <div>&copy; 2025 GoStudy Inc. All rights reserved. Built for the future of education.</div>
        <div class="flex gap-8">
          <a href="/privacy/" class="hover:text-dark transition-colors">Privacy Policy</a>
          <a href="/terms/" class="hover:text-dark transition-colors">Terms of Service</a>
        </div>
      </div>
    </div>
  </footer>
    <script src="/assets/js/navbar.js"></script>
    
    <script type="module">
      import {
        auth,
        onAuthStateChanged,
        signOut,
        updateProfile,
        updateEmail,
        updatePassword,
        deleteUser,
        reauthenticate,
        API_BASE,
      } from "/backend/js/auth.js";

      async function loadHistory(idToken) {
        const container = document.getElementById("history-container");
        try {
          const res = await fetch(`${API_BASE}/api/generations`, {
            headers: { Authorization: `Bearer ${idToken}` },
          });
          if (!res.ok) throw new Error("Failed to fetch history");
          const data = await res.json();

          if (data.length === 0) {
            container.innerHTML = `<p class="text-gray-400 text-sm text-center py-8">No past generations found.</p>`;
            return;
          }

          container.innerHTML = data
            .map(
              (item, index) => `
                <div class="history-item p-4 rounded-2xl border border-gray-100 hover:border-primary/20 hover:bg-primary/[0.02] transition-all group cursor-pointer" data-index="${index}">
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-bold text-dark">${
                              item.fileName || "Untitled Document"
                            }</div>
                            <div class="text-xs text-gray-400">${new Date(
                              item.createdAt?._seconds * 1000 || Date.now()
                            ).toLocaleDateString()}</div>
                        </div>
                        <span class="material-icons-round text-gray-300 group-hover:text-primary transition-colors">visibility</span>
                    </div>
                    <div id="plan-details-${index}" class="hidden mt-4 pt-4 border-t border-gray-100 animate-fade-in">
                        <p class="text-sm text-gray-600 leading-relaxed">${
                          item.studyPlan?.summary || "No summary available."
                        }</p>
                        <div class="mt-4 flex gap-2">
                            <button onclick="event.stopPropagation(); window.location.href='/dashboard/'" class="text-xs font-bold text-primary">Open in Dashboard</button>
                        </div>
                    </div>
                </div>
            `
            )
            .join("");

          // Add Click Handlers
          document.querySelectorAll(".history-item").forEach((item) => {
            item.addEventListener("click", () => {
              const idx = item.getAttribute("data-index");
              const details = document.getElementById(`plan-details-${idx}`);
              details.classList.toggle("hidden");
            });
          });
        } catch (e) {
          container.innerHTML = `<p class="text-red-400 text-sm text-center py-8">Error loading history.</p>`;
        }
      }

      // PFP Grid Logic
      const pfpUrls = [
        '/assets/pfp/User 01a.png', '/assets/pfp/User 01b.png', '/assets/pfp/User 01c.png',
        '/assets/pfp/User 02a.png', '/assets/pfp/User 02b.png', '/assets/pfp/User 02c.png',
        '/assets/pfp/User 03a.png', '/assets/pfp/User 03b.png', '/assets/pfp/User 03C.png',
        '/assets/pfp/User 04a.png', '/assets/pfp/User 04b.png', '/assets/pfp/User 04c.png',
        '/assets/pfp/User 05a.png', '/assets/pfp/User 05b.png', '/assets/pfp/User 05c.png',
        '/assets/pfp/User 06a.png', '/assets/pfp/User 06b.png', '/assets/pfp/User 06c.png',
        '/assets/pfp/User 07a.png', '/assets/pfp/User 07b.png', '/assets/pfp/User 07c.png'
      ];

      const pfpGrid = document.getElementById('pfp-grid');
      const pfpInput = document.getElementById('profile-pfp-url');

      function initPfpGrid(currentUrl) {
          if (!pfpGrid) return;
          pfpGrid.innerHTML = '';
          pfpUrls.forEach(url => {
              const div = document.createElement('div');
              div.className = `pfp-option rounded-xl overflow-hidden aspect-square flex items-center justify-center bg-white shadow-sm ${url === currentUrl ? 'selected' : ''}`;
              div.innerHTML = `<img src="${url}" class="w-full h-full object-cover" alt="Avatar">`;
              div.onclick = () => {
                  document.querySelectorAll('.pfp-option').forEach(opt => opt.classList.remove('selected'));
                  div.classList.add('selected');
                  pfpInput.value = url;
              };
              pfpGrid.appendChild(div);
          });
      }

    // --- Profile Updates ---
    document.getElementById('edit-profile-btn')?.addEventListener('click', async () => {
        const user = auth.currentUser;
        if (!user) return;

        const name = document.getElementById('profile-name').value;
        const email = document.getElementById('profile-email').value;
        const photoURL = document.getElementById('profile-pfp-url').value;
        const password = document.getElementById('profile-password').value;

        const btn = document.getElementById('edit-profile-btn');
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = "Updating...";

        try {
            const token = await user.getIdToken();

            // 1. Update Profile Info (Name, PFP)
            if (name !== user.displayName || photoURL !== user.photoURL) {
                const res = await fetch(`${API_BASE}/api/profile`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ displayName: name, photoURL: photoURL })
                });

                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.error || "Failed to update profile");
                }
            }

            // 2. Update Sensitive Info (Email, Password)
            if ((email && email !== user.email) || password) {
                const currentPassword = prompt("Please enter your current password to update email or password:");
                if (currentPassword) {
                    // Client-side re-auth for security check before calling backend
                    await reauthenticate(currentPassword);
                    
                    const res = await fetch(`${API_BASE}/api/account`, {
                        method: 'PUT',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}` // Token usually stays valid
                        },
                        body: JSON.stringify({ email: email, password: password })
                    });

                    if (!res.ok) {
                        const error = await res.json();
                        throw new Error(error.error || "Failed to update account credentials");
                    }
                } else {
                    throw new Error("Password required for email/password changes.");
                }
            }

            btn.disabled = false;
            btn.innerText = originalText;
            alert("Profile updated successfully!");
            window.location.reload();
        } catch (e) {
            console.error(e);
            alert("Update failed: " + e.message);
            btn.disabled = false;
            btn.innerText = originalText;
        }
    });

    // --- Delete Account ---
    document.getElementById('delete-account-btn')?.addEventListener('click', async () => {
        if (!confirm("Are you SURE you want to delete your account? This cannot be undone.")) return;
        
        const user = auth.currentUser;
        if (!user) return;

        try {
            const currentPassword = prompt("Please enter your password to confirm account deletion:");
            if (currentPassword) {
                // Client-side re-auth for security check
                await reauthenticate(currentPassword);
                
                const token = await user.getIdToken();
                const res = await fetch(`${API_BASE}/api/account`, {
                    method: 'DELETE',
                    headers: { 
                        'Authorization': `Bearer ${token}` 
                    }
                });

                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.error || "Failed to delete account");
                }
                
                await signOut(auth);
                window.location.href = "/index.html";
            }
        } catch (e) {
            console.error(e);
            alert("Deletion failed: " + e.message);
        }
    });

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          const token = await user.getIdToken();
          loadHistory(token);
          loadUsage(token);
          loadPreferences(token);

          // Populate profile fields
          const nameInput = document.getElementById('profile-name');
          const emailInput = document.getElementById('profile-email');
          const nameText = document.getElementById('profile-display-name-text');
          const emailText = document.getElementById('profile-email-text');
          const profileImg = document.getElementById('profile-img-display');
          const profileInitials = document.getElementById('profile-initials');

          if (nameInput) nameInput.value = user.displayName || "";
          if (emailInput) emailInput.value = user.email || "";
          if (nameText) nameText.innerText = user.displayName || user.email?.split('@')[0] || "Student";
          if (emailText) emailText.innerText = user.email || "";
          
          if (user.photoURL) {
              if (profileImg) {
                  profileImg.src = user.photoURL;
                  profileImg.classList.remove('hidden');
              }
              if (profileInitials) profileInitials.classList.add('hidden');
          } else {
              if (profileInitials) {
                  const initials = (user.displayName || user.email || "??").split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                  profileInitials.innerText = initials;
                  profileInitials.classList.remove('hidden');
              }
              if (profileImg) profileImg.classList.add('hidden');
          }

          // Initialize PFP grid with current user photoURL
          if (typeof initPfpGrid === 'function') initPfpGrid(user.photoURL);
        }
      });
      
      // --- LOAD USAGE DATA ---
      async function loadUsage(idToken) {
          try {
              const res = await fetch(`${API_BASE}/api/usage`, {
                  headers: { Authorization: `Bearer ${idToken}` }
              });
              
              if (!res.ok) throw new Error('Failed to fetch usage');
              
              const data = await res.json();
              
              // Update UI elements
              const planName = document.getElementById('plan-name');
              const planIcon = document.getElementById('plan-icon');
              const planActions = document.getElementById('plan-actions');
              const usageCount = document.getElementById('usage-count');
              const usageBar = document.getElementById('usage-bar');
              const usageRemaining = document.getElementById('usage-remaining');
              
              // Set plan name and styling
              if (data.plan === 'pro') {
                  planName.innerText = 'Pro Plan';
                  planIcon.classList.remove('bg-blue-100', 'text-blue-600');
                  planIcon.classList.add('bg-amber-100', 'text-amber-600');
                  planIcon.innerHTML = '<span class="material-icons-round text-2xl">star</span>';
                  planActions.innerHTML = '<span class="text-sm text-gray-500">Your Pro subscription is active</span>';
                  usageBar.classList.remove('from-blue-500', 'to-indigo-500');
                  usageBar.classList.add('from-amber-500', 'to-orange-500');
              }
              
              // Update usage stats
              usageCount.innerText = `${data.uploadsThisMonth} / ${data.limit}`;
              usageBar.style.width = `${Math.min(100, (data.uploadsThisMonth / data.limit) * 100)}%`;
              usageRemaining.innerText = `${data.remaining} upload${data.remaining !== 1 ? 's' : ''} remaining this month`;
              
              // Warning style if near limit
              if (data.remaining <= 1 && data.plan === 'free') {
                  usageBar.classList.remove('from-blue-500', 'to-indigo-500');
                  usageBar.classList.add('from-red-500', 'to-orange-500');
                  usageRemaining.classList.add('text-red-500');
              }
          } catch (e) {
              console.error('Failed to load usage:', e);
          }
      }

      // --- LOAD & SAVE PREFERENCES ---
      async function loadPreferences(idToken) {
          try {
              const res = await fetch(`${API_BASE}/api/preferences`, {
                  headers: { Authorization: `Bearer ${idToken}` }
              });
              
              if (!res.ok) throw new Error('Failed to fetch preferences');
              
              const prefs = await res.json();
              
              // Populate UI
              if (document.getElementById('pref-tone')) document.getElementById('pref-tone').value = prefs.tone;
              if (document.getElementById('pref-pace')) document.getElementById('pref-pace').value = prefs.pace;
              if (document.getElementById('pref-reminder')) document.getElementById('pref-reminder').value = prefs.reminder_frequency;
              if (document.getElementById('pref-focus')) document.getElementById('pref-focus').value = prefs.focus_preference;
              if (document.getElementById('pref-difficulty')) document.getElementById('pref-difficulty').checked = prefs.difficulty_adaptation;

          } catch (e) {
              console.error('Failed to load preferences:', e);
          }
      }

      document.getElementById('save-prefs-btn')?.addEventListener('click', async () => {
          const user = auth.currentUser;
          if (!user) return;

          const btn = document.getElementById('save-prefs-btn');
          const originalText = btn.innerText;
          btn.disabled = true;
          btn.innerText = "Saving...";

          const prefs = {
              tone: document.getElementById('pref-tone').value,
              pace: document.getElementById('pref-pace').value,
              reminder_frequency: document.getElementById('pref-reminder').value,
              focus_preference: document.getElementById('pref-focus').value,
              difficulty_adaptation: document.getElementById('pref-difficulty').checked
          };

          try {
              const token = await user.getIdToken();
              const res = await fetch(`${API_BASE}/api/preferences`, {
                  method: 'PUT',
                  headers: { 
                      'Content-Type': 'application/json',
                      'Authorization': `Bearer ${token}`
                  },
                  body: JSON.stringify(prefs)
              });

              if (!res.ok) throw new Error("Failed to save preferences");

              btn.innerText = "Saved!";
              setTimeout(() => {
                  btn.disabled = false;
                  btn.innerText = originalText;
              }, 2000);

          } catch (e) {
              console.error(e);
              alert("Save failed: " + e.message);
              btn.disabled = false;
              btn.innerText = originalText;
          }
      });

    </script>
  </body>
</html>
